name: SMS Scheduler

on:
  schedule:
    # 매일 오전 8시, 10시, 11시, 12시, 16시, 17시 (한국시간 기준)
    # UTC 기준: 23시(전날), 1시, 2시, 3시, 7시, 8시
    - cron: '0 23 * * *'   # KST 08:00 - 당일 아침 SMS
    - cron: '0 1 * * *'    # KST 10:00 - D-1 안내 SMS
    - cron: '30 2 * * *'   # KST 11:30 - 당일 야유회 식사 안내
    - cron: '0 7 * * *'    # KST 16:00 - 당일 야유회 퇴실 안내
    - cron: '30 8 * * *'   # KST 17:30 - 1박2일 식사 안내
    - cron: '0 1 * * *'    # KST 10:00 - 퇴실 안내

  workflow_dispatch: # 수동 실행 가능

jobs:
  send-sms:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger SMS API
        id: sms
        run: |
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "${{ secrets.VERCEL_URL }}/api/cron/sms" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60)

          echo "HTTP Status: $HTTP_CODE"
          cat response.json

          # 500번대 에러만 실패로 처리 (발송 건 없음, 스킵은 정상 처리)
          if [ "$HTTP_CODE" -ge 500 ]; then
            echo "Server error occurred"
            exit 1
          fi

          echo "SMS cron completed successfully (status: $HTTP_CODE)"
